 <html>
<head>
	<title>Народный контроллер ТН</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type='text/javascript' src='scripts.js'></script>
<script type="text/javascript" src="jquery.min.js"></script>
<script src="highstock.js"></script>
<script src="exporting.js"></script>
<script src="export-csv.js"></script>
	
	<script type="text/javascript">
/**
 * Grid-light theme for Highcharts JS
 * @author Torstein Honsi
 */
Highcharts.theme = {
	colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee", "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
	chart: {
		backgroundColor: null,
	},
	title: {
		style: {
			fontSize: '16px',
			fontWeight: 'bold',
			textTransform: 'uppercase'
		}
	},
	tooltip: {
		borderWidth: 0,
		backgroundColor: 'rgba(219,219,216,0.8)',
		shadow: false
	},
	legend: {
		itemStyle: {
			fontWeight: 'bold',
			fontSize: '13px'
		}
	},
	xAxis: {
		gridLineWidth: 1,
		labels: {
			style: {
				fontSize: '10px'
			}
		}
	},
	yAxis: {
		minorTickInterval: 'auto',
		title: {
			style: {
				textTransform: 'uppercase'
			}
		},
		labels: {
			style: {
				fontSize: '10px'
			}
		}
	},
	plotOptions: {
		candlestick: {
			lineColor: '#404048'
		}
	},
	// General
	background2: '#F0F0EA'
};
// Apply the theme
Highcharts.setOptions(Highcharts.theme);
window.onload = function() {
	loadParam("get_listStats");
}
function loadParam_after(paramid) {
	if(paramid.indexOf("_listStats")!=-1) {
		var els = document.getElementById('get_liststats').options;
		for(var i = 0; i < els.length; i++) els[i].text = els[i].text.replace(/[^\d]/g,'');
		init_chart();
	}
}
var csv_line_delim = '\n';
var csv_delim = ';';
//fieldList shows which field you want to load, and which axis to display that field on, 
//the 'T' Temperature left axis, or the 'O' Other right axis.
var fieldList = [];
var file_head = 'stats';
var dynamicChart;
var GrpFinished = 0;
// user's timezone offset
var myOffset = new Date().getTimezoneOffset();
var xAxisName;

// create the chart when all data is loaded
function createChart() {
	// specify the chart options
	var chartOptions = {
		chart: {
			renderTo: 'chart-container',
			zoomType: '',
			events: {
				load: function() {	}
			}
		},
		rangeSelector: {
			buttons: [{
				count: 30,
				type: 'minute',
				text: '30M'
			}, {
				count: 12,
				type: 'hour',
				text: '12Ч'
			}, {
				count: 1,
				type: 'day',
				text: '1Д'
			}, {
				count: 2,
				type: 'day',
				text: '2Д'
			}, {
				count: 3,
				type: 'day',
				text: '3Д'
			}, {
				count: 1,
				type: 'week',
				text: 'нед'
			}, {
				count: 1,
				type: 'month',
				text: 'мес'
			}, {
				count: 1,
				type: 'year',
				text: 'год'
			}, {
				type: 'all',
				text: 'всё'
			}],
			
		
			selected: 1
		},
		title: {
			text: ''
		},
		plotOptions: {
			line: {
				gapSize: 5,
				lineWidth : 2
				//color: '#d62020'
				//  },
				//  bar: {
				//color: '#d52020'
				//  },
				//  column: {
			},
			series: {
				marker: {
					radius: 2
				},
				animation: true,
				step: false,
				turboThrehold: 1000,
				borderWidth: 0
			}
		},
		tooltip: {
			valueDecimals: 1,
			valueSuffix: '',
			xDateFormat: '%d.%m.%Y<br/>%H:%M:%S'
			// reformat the tooltips so that local times are displayed
			//formatter: function() {
			//var d = new Date(this.x + (myOffset*60000));
			//var n = (this.point.name === undefined) ? '' : '<br/>' + this.point.name;
			//return this.series.name + ':<b>' + this.y + '</b>' + n + '<br/>' + d.toDateString() + '<br/>' + d.toTimeString().replace(/\(.*\)/, "");
			//}
		},
		xAxis: {
			lineWidth: 0,
			gridLineDashStyle: 'longdash',
			gridLineColor: 'blue',
			type: 'datetime',
			ordinal: false,
			dateTimeLabelFormats: {
				hour: '%H',
				minute: '%H:%M',
			    day: '%e. %b',
			    week: '%e. %b',
			    month: '%b \'%y',
			    year: '%Y'
			},			
			title: {
				text: 'Время'
			}
		},
		yAxis: 		
		 [
		  {
		  
			title: {
				text: 'Температура, °C'
			},
			opposite: false,
			showEmpty: false,
			id: 'T'
		}, {
			title: {
				text: 'Давление, бар.'
			},
			opposite: true,
			showEmpty: false,
			id: 'P'
		}, {
			title: {
				text: 'Напряжение, V'
			},
			opposite: true,
			showEmpty: false,
			id: 'V'
		}, {
			title: {
				text: 'Мощность, кВт'
			},
			opposite: true,
			showEmpty: false,
			id: 'W'
		}, {
			title: {
				text: 'COP'
			},
			opposite: true,
			showEmpty: false,
			id: 'C'
		}, {
			title: {
				text: 'Моточасы, м'
			},
			opposite: true,
			showEmpty: false,
			id: 'M'
		}],
		exporting: {
			enabled: true,
			csv: {
				dateFormat: '%Y-%m-%d %I:%M:%S %p'
			}
		},
		legend: {
			enabled: true
		},
		navigator: {
			baseSeries: 0, //select which series to show in history navigator, First series is 0
			series: {
				includeInCSVExport: false
			}
		},
		series: []
		//series: [{data:[[getChartDate("2013-06-16T00:32:40Z"),75]]}]      
	};
	for(var fieldIndex = 0; fieldIndex < fieldList.length; fieldIndex++) // add each field
	{
		chartOptions.series.push({
			data: fieldList[fieldIndex].data,
			index: fieldList[fieldIndex].series,
			yAxis: fieldList[fieldIndex].axis,
			//visible:false,
			name: fieldList[fieldIndex].name
		});
	}
	// set chart labels here so that decoding occurs properly
	//chartOptions.title.text = data.channel.name;
	chartOptions.xAxis.title.text = xAxisName;
	// draw the chart
	dynamicChart = new Highcharts.StockChart(chartOptions);
	// update series number to account for the navigator series (The historical series at the bottom) which is the first series.
	for(var fieldIndex = 0; fieldIndex < fieldList.length; fieldIndex++) // and each field
	{
		for(var seriesIndex = 0; seriesIndex < dynamicChart.series.length; seriesIndex++) // compare each series name
		{
			if(dynamicChart.series[seriesIndex].name == fieldList[fieldIndex].name) {
				fieldList[fieldIndex].series = seriesIndex;
			}
		}
	}
}

// converts date format from csv
function getChartTime(d) {
	// get the data using javascript's date object (year, month, day, hour, minute, second)
	return Date.UTC(d.substring(0, 4), d.substring(4, 6) - 1, d.substring(6, 8), d.substring(8, 10), d.substring(10, 12), d.substring(12, 14)) - (myOffset * 60000);
}
function getChartDate(d) {
	return Date.UTC(d.substring(0, 4), d.substring(4, 6) - 1, d.substring(6, 8), 0, 0, 0) - (myOffset * 60000);
}

// Hide all series, via 'Hide All' button.  Then user can click on serries name in legent to show series of interest.      
function HideAll() {
	for(var index = 0; index < dynamicChart.series.length; index++) // iterate through each series
	{
		if(dynamicChart.series[index].name == 'Navigator') continue;
		dynamicChart.series[index].hide();
	}
}
var urlhead = urlcontrol == '' ? '' : urlcontrol + '/';

function init_chart() {
	var dh = $.get(urlhead + file_head + '_head.csv', function(data) { // format: <axis char><field1 name>;<axis char><field2 name>;... Axis = 'T' - temperature, 'P' - bar, 'W' - kWt
		var arr = data.split(csv_delim);
		for(var i = 0; i < arr.length; i++) {
			if(i == 0) {
				xAxisName = arr[i];
				continue;
			}
			fieldList.push({
				field: i + 1,
				axis: arr[i].substr(0, 1),
				name: arr[i].substr(1),
				data: []
			});
		}
	}).fail(function() { alert('Get header failed!'); });
	$.when(dh).done(function() {
		var seriesCounter = 0
		for(var j = 0; j < fieldList.length; j++) fieldList[j].series = seriesCounter++;
		var els = document.getElementById("get_liststats").options;
		if(els.length) { $.when(loadChartsGroup(els[els.selectedIndex].text)).done(function() {	createChart(); });	}
	});
}

// load chart with period
function loadChartsGroup(period) {
	return $.get(urlhead + file_head + "_" + period + '.dat', function(data) {
		var feeds = data.split(csv_line_delim);
		for(var h = 0; h < feeds.length; h++) {
			var arr = feeds[h].split(csv_delim);
			if(arr.length == 0) continue;
			var dt = getChartDate(arr[0]);
			for(var fi = 1; fi < arr.length; fi++) {
				var p = [dt, parseFloat(arr[fi])];
				if(!isNaN(p[1])) fieldList[fi - 1].data.push(p);
			}
		}
	}).fail(function() {
		alert('Get chart data ' + period + ' failed!');
	});
}

function loadSelected() {
	var els = document.getElementById("get_liststats").options;
	var dt = Number(els[els.selectedIndex].text);
	if(dynamicChart.series.length && dynamicChart.series[0].xData.length && dt >= new Date(dynamicChart.series[0].xData[0]).getFullYear() && dt <= new Date(dynamicChart.series[0].xData[dynamicChart.series[0].xData.length-1]).getFullYear()) return;
	$.when(loadChartsGroup(dt)).done(function() {
		for(var fieldIndex = 0; fieldIndex < fieldList.length; fieldIndex++) {
			fieldList[fieldIndex].data.sort(function(a, b) {
				return a[0] - b[0];
			});
			dynamicChart.series[fieldList[fieldIndex].series].setData(fieldList[fieldIndex].data, false);
		}
		dynamicChart.redraw();
	});
}
</script>	
</head>
<body class="index">
<div id="menu" class="menu"><script src="menu.js"></script></div>
<div class="content">
	
<h2>Статистика по дням</h2>
	<div id="BelowChart"> 
		Год: <select id="get_liststats"></select>
		<button onClick="loadSelected();">Загрузить</button>
		<button value="Hide All" name="Hide All Button" onClick="HideAll();">Скрыть все</button>
	</div>
	<div id="chart-container" style="height: 600px;"><br>
	Идет загрузка...<br>
	</div>
	<div id="BelowChart" style="height: 500px"> 
	</div>	
	
</div>
</body>
</html>
