<!DOCTYPE html>
<html><head>
<meta content="text/html" charset="UTF-8" http-equiv="content-type">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="jquery.min.js"></script>
<script src="highstock.js"></script>
<script src="exporting.js"></script>
<script src="export-csv.js"></script>
<script type='text/javascript' src='scripts.js'></script>
<script type="text/javascript">
/**
 * Grid-light theme for Highcharts JS
 * @author Torstein Honsi
 */
Highcharts.theme = {
	colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee", "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
	chart: {
		backgroundColor: null,
	},
	title: {
		style: {
			fontSize: '16px',
			fontWeight: 'bold',
			textTransform: 'uppercase'
		}
	},
	tooltip: {
		borderWidth: 0,
		backgroundColor: 'rgba(219,219,216,0.8)',
		shadow: false
	},
	legend: {
		itemStyle: {
			fontWeight: 'bold',
			fontSize: '13px'
		}
	},
	xAxis: {
		gridLineWidth: 1,
		labels: {
			style: {
				fontSize: '12px'
			}
		}
	},
	yAxis: {
		minorTickInterval: 'auto',
		title: {
			style: {
				textTransform: 'uppercase'
			}
		},
		labels: {
			style: {
				fontSize: '12px'
			}
		}
	},
	plotOptions: {
		candlestick: {
			lineColor: '#404048'
		}
	},
	// General
	background2: '#F0F0EA'
};
// Apply the theme
Highcharts.setOptions(Highcharts.theme);
var csv_line_delim = '\n';
var csv_delim = ';';
//fieldList shows which field you want to load, and which axis to display that field on, 
//the 'T' Temperature left axis, or the 'O' Other right axis.
var ChartsGrp = [];
ChartsGrp.push({
	name: 'Статистика',
	key: 'stats',
	fieldList: []
});
var StatID = 0;
var dynamicChart;
var GrpFinished = 0;
// user's timezone offset
var myOffset = new Date().getTimezoneOffset();

// create the chart when all data is loaded
function createChart() {
	// specify the chart options
	var chartOptions = {
		chart: {
			renderTo: 'chart-container',
			zoomType: '',
			events: {
				load: function() {	}
			}
		},
		rangeSelector: {
			buttons: [{
				count: 30,
				type: 'minute',
				text: '30M'
			}, {
				count: 12,
				type: 'hour',
				text: '12Ч'
			}, {
				count: 1,
				type: 'day',
				text: '1Д'
			}, {
				count: 2,
				type: 'day',
				text: '2Д'
			}, {
				count: 3,
				type: 'day',
				text: '3Д'
			}, {
				count: 1,
				type: 'week',
				text: 'нед'
			}, {
				count: 1,
				type: 'month',
				text: 'мес'
			}, {
				count: 1,
				type: 'year',
				text: 'год'
			}, {
				type: 'all',
				text: 'всё'
			}],
			inputEnabled: true,
			selected: 1
		},
		title: {
			text: ''
		},
		plotOptions: {
			line: {
				gapSize: 5
				//color: '#d62020'
				//  },
				//  bar: {
				//color: '#d52020'
				//  },
				//  column: {
			},
			series: {
				marker: {
					radius: 2
				},
				animation: true,
				step: false,
				turboThrehold: 1000,
				borderWidth: 0
			}
		},
		tooltip: {
			valueDecimals: 1,
			valueSuffix: '',
			xDateFormat: '%d.%m.%Y<br/>%H:%M:%S'
			// reformat the tooltips so that local times are displayed
			//formatter: function() {
			//var d = new Date(this.x + (myOffset*60000));
			//var n = (this.point.name === undefined) ? '' : '<br/>' + this.point.name;
			//return this.series.name + ':<b>' + this.y + '</b>' + n + '<br/>' + d.toDateString() + '<br/>' + d.toTimeString().replace(/\(.*\)/, "");
			//}
		},
		xAxis: {
			type: 'datetime',
			ordinal: false,
			dateTimeLabelFormats: {
				hour: '%H',
				minute: '%H:%M',
			    day: '%e. %b',
			    week: '%e. %b',
			    month: '%b \'%y',
			    year: '%Y'
			},
			title: {
				text: ''
			}
		},
		yAxis: [{
			title: {
				text: 'Температура, °C'
			},
			id: 'T'
		}, {
			title: {
				text: 'Давление, бар.'
			},
			opposite: true,
			id: 'P'
		}],
		exporting: {
			enabled: true,
			csv: {
				dateFormat: '%Y-%m-%d %I:%M:%S %p'
			}
		},
		legend: {
			enabled: true
		},
		navigator: {
			baseSeries: 0, //select which series to show in history navigator, First series is 0
			series: {
				includeInCSVExport: false
			}
		},
		series: []
		//series: [{data:[[getChartDate("2013-06-16T00:32:40Z"),75]]}]      
	};
	// add all Channel data to the chart
	for(var channelIndex = 0; channelIndex < ChartsGrp.length; channelIndex++) // iterate through each channel
	{
		if(!ChartsGrp[channelIndex].loaded) continue;
		for(var fieldIndex = 0; fieldIndex < ChartsGrp[channelIndex].fieldList.length; fieldIndex++) // add each field
		{
			chartOptions.series.push({
				data: ChartsGrp[channelIndex].fieldList[fieldIndex].data,
				index: ChartsGrp[channelIndex].fieldList[fieldIndex].series,
				yAxis: ChartsGrp[channelIndex].fieldList[fieldIndex].axis,
				//visible:false,
				name: ChartsGrp[channelIndex].fieldList[fieldIndex].name
			});
		}
	}
	// set chart labels here so that decoding occurs properly
	//chartOptions.title.text = data.channel.name;
	chartOptions.xAxis.title.text = 'Date';
	// draw the chart
	dynamicChart = new Highcharts.StockChart(chartOptions);
	// update series number to account for the navigator series (The historical series at the bottom) which is the first series.
	for(var channelIndex = 0; channelIndex < ChartsGrp.length; channelIndex++) // iterate through each channel
	{
		if(!ChartsGrp[channelIndex].loaded) continue;
		for(var fieldIndex = 0; fieldIndex < ChartsGrp[channelIndex].fieldList.length; fieldIndex++) // and each field
		{
			for(var seriesIndex = 0; seriesIndex < dynamicChart.series.length; seriesIndex++) // compare each series name
			{
				if(dynamicChart.series[seriesIndex].name == ChartsGrp[channelIndex].fieldList[fieldIndex].name) {
					ChartsGrp[channelIndex].fieldList[fieldIndex].series = seriesIndex;
				}
			}
		}
	}
	// add all history
	//dynamicChart.showLoading("Loading History..." );
//	for(var channelIndex = 0; channelIndex < ChartsGrp.length; channelIndex++) // iterate through each channel
//	{
//		(function(channelIndex) {
//			//load only 1 set of points
//			loadChannelHistory(channelIndex, ChartsGrp[channelIndex].channelNumber, ChartsGrp[channelIndex].key, ChartsGrp[channelIndex].fieldList, 0, 1);
//		})(channelIndex);
//	}
}

// converts date format from csv
function getChartDate(d) {
	// get the data using javascript's date object (year, month, day, hour, minute, second)
	// months in javascript start at 0, so remember to subtract 1 when specifying the month
	// offset in minutes is converted to milliseconds and subtracted so that chart's x-axis is correct
	return Date.UTC(d.substring(0, 4), d.substring(4, 6) - 1, d.substring(6, 8), d.substring(8, 10), d.substring(10, 12), d.substring(12, 14)) - (myOffset * 60000);
}
// Hide all series, via 'Hide All' button.  Then user can click on serries name in legent to show series of interest.      
function HideAll() {
	for(var index = 0; index < dynamicChart.series.length; index++) // iterate through each series
	{
		if(dynamicChart.series[index].name == 'Navigator') continue;
		dynamicChart.series[index].hide();
	}
}
var urlhead = urlcontrol == '' ? '' : urlcontrol + '/';
//  This is where the chart is generated.
$(document).ready(function() {
	//Add Channel Load Menu
	var dt = new Date();
	document.getElementById("EndDate").value = dt.toISOString().substring(0, 10);
	dt = new Date(dt.getTime()-365*24*60*60*1000);
	document.getElementById("StartDate").value = dt.toISOString().substring(0, 10);
	var menu = document.getElementById("GroupSelect");
	for(var i = 0; i < ChartsGrp.length; i++) // iterate through each channel
	{
		var menuOption = new Option(ChartsGrp[i].name, i);
		menu.options.add(menuOption, i);
		var dh = $.get(urlhead + ChartsGrp[i].key + '_head.csv', function(data) { // format: <axis char><field1 name>;<axis char><field2 name>;... Axis = 'T' - temperature, 'P' - bar, 'W' - kWt
			var arr = data.split(csv_delim);
			for(var i = 0; i < arr.length; i++) {
				ChartsGrp[StatID].fieldList.push({
					field: i + 1,
					axis: arr[i].substr(0, 1),
					name: arr[i].substr(1),
					data: []
				});
			}
		}).fail(function() {
			alert('Get ' + ChartsGrp[i].key + ' head failed!');
		});
		$.when(dh).done(function() {
			var seriesCounter = 0
			for(var i = 0; i < ChartsGrp.length; i++) {
				for(var j = 0; j < ChartsGrp[i].fieldList.length; j++) ChartsGrp[i].fieldList[j].series = seriesCounter++;
			}
			for(var i = 0; i < ChartsGrp.length; i++) {
				ChartsGrp[i].loaded = false;
				$.when(loadChartsGroup(i)).done(function() {
					if(++GrpFinished >= ChartsGrp.length) createChart(); 
				});
			}
		});
	}
});

// load chart with period: StartDate, EndDate
function loadChartsGroup(ChartGroup) {
	return $.get(urlhead + ChartsGrp[ChartGroup].key + "_" + document.getElementById("StartDate").value.replace(/-/g,'').substr(0, 4) + '.dat', function(data) {
		var feeds = data.split(csv_line_delim);
		for(var h = 0; h < feeds.length; h++) {
			var arr = feeds[h].split(csv_delim);
			if(arr.length == 0) continue;
			var dt = getChartDate(arr[0]);
			for(var fi = 1; fi < arr.length; fi++) {
				var p = [dt, parseFloat(arr[fi])];
				if(!isNaN(p[1])) ChartsGrp[ChartGroup].fieldList[fi - 1].data.push(p);
			}
		}
		ChartsGrp[ChartGroup].loaded = true;
	}).fail(function() {
		alert('Get chart #' + ChartGroup + ' data failed!');
	});
}

function loadSelected() {
	ChartGroup = document.getElementById("GroupSelect").selectedIndex;
	$.when(loadChartsGroup(ChartGroup)).done(function() {
		for(var fieldIndex = 0; fieldIndex < ChartsGrp[ChartGroup].fieldList.length; fieldIndex++) {
			ChartsGrp[ChartGroup].fieldList[fieldIndex].data.sort(function(a, b) {
				return a[0] - b[0]
			});
			dynamicChart.series[ChartsGrp[ChartGroup].fieldList[fieldIndex].series].setData(ChartsGrp[ChartGroup].fieldList[fieldIndex].data, false);
		}
		dynamicChart.redraw()
	});
}
</script>
<title>Статистика по дням</title>
</head>
<body>
 <div id="menu" class="menu"><script src="menu.js"></script></div>
 <div class="content">
	<div id="BelowChart"> 
		с <input id="StartDate" type="number" min="2018"> по <input id="EndDate" type="number" min="2018">  
		<button onclick="loadSelected();">Загрузить</button>
		<button value="Hide All" name="Hide All Button" onclick="HideAll();">Скрыть все</button>
	</div>
	<div id="chart-container" style="height: 600px"><br>
	Идет загрузка...<br>
	</div>
	<div id="BelowChart" style="height: 500px"> 
	</div>
 </div>
</body>
</html>
